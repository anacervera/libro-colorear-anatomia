<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Libro de colorear – Anatomía</title>

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
body { margin: 0; background: #f6f6f6; }

header{
  position: sticky; top: 0; z-index: 10;
  background: white; border-bottom: 1px solid #ddd;
  padding: 10px 12px;
  display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
}

.wrap{ display: grid; place-items: center; padding: 12px; }

.stage{
  position: relative;
  background: white;
  border: 1px solid #ccc;
  border-radius: 10px;
  overflow: hidden;
  touch-action: none;
  box-shadow: 0 4px 14px rgba(0,0,0,.08);
  transform-origin: 0 0;
}

#paint,#overlay{
  position:absolute;
  left:0; top:0;
  width:100%; height:100%;
}

#overlay{ pointer-events:none; }

.btn{
  padding:6px 10px;
  border:1px solid #ccc;
  background:#fff;
  border-radius:8px;
  cursor:pointer;
}

.iconbtn{
  width:34px;height:34px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border:1px solid #ccc;
  background:#fff;
  border-radius:10px;
  text-decoration:none;
  color:#333;
}

.pill{
  padding:6px 10px;
  border:1px solid #ccc;
  background:#fff;
  border-radius:999px;
}

.palette{ display:flex; gap:6px; align-items:center; }
.swatch{
  width:22px;height:22px;
  border-radius:6px;
  border:1px solid #bbb;
  cursor:pointer;
}
.swatch.active{ outline:2px solid #111; }

</style>
</head>

<body>

<header>
<a class="iconbtn" href="../" title="Volver al índice">⌂</a>
<strong>Colorear</strong>

<span class="pill">
<label><input type="radio" name="tool" value="brush" checked> Pincel</label>
<label style="margin-left:8px"><input type="radio" name="tool" value="eraser"> Borrador</label>
</span>

<span class="pill">
<input id="size" type="range" min="2" max="60" value="14">
<span id="sizeVal">14</span> px
</span>

<input id="color" type="color" value="#ff3b30">

<div class="palette pill" id="palette"></div>

<button class="btn" id="undo">Deshacer</button>
<button class="btn" id="redo">Rehacer</button>
<button class="btn" id="clear">Reset</button>
<button class="btn" id="save">Guardar PNG</button>
</header>

<div class="wrap">
<div class="stage" id="stage">
<canvas id="paint"></canvas>
<canvas id="overlay"></canvas>
</div>
</div>

<script>
(() => {

const imgSrc="Medula2.png";

const paint=document.getElementById("paint");
const overlay=document.getElementById("overlay");
const stage=document.getElementById("stage");

const ctx=paint.getContext("2d");
const octx=overlay.getContext("2d",{willReadFrequently:true});

const sizeInput=document.getElementById("size");
const sizeVal=document.getElementById("sizeVal");
const colorInput=document.getElementById("color");
const undoBtn=document.getElementById("undo");
const redoBtn=document.getElementById("redo");
const clearBtn=document.getElementById("clear");
const saveBtn=document.getElementById("save");
const toolRadios=[...document.querySelectorAll('input[name="tool"]')];

sizeInput.addEventListener("input",()=>sizeVal.textContent=sizeInput.value);

// ===== Zoom state =====
let viewScale=1;
let viewX=0;
let viewY=0;
let baseW=1;
let baseH=1;

function applyView(){
stage.style.transform=`translate(${viewX}px,${viewY}px) scale(${viewScale})`;
}

function clampScale(s){
return Math.min(5,Math.max(0.5,s));
}

// ===== Coordenadas correctas =====
function getPos(evt){
const rect=stage.getBoundingClientRect();
const sx=evt.clientX-rect.left;
const sy=evt.clientY-rect.top;

const xStage=sx/viewScale;
const yStage=sy/viewScale;

const x=xStage*(paint.width/baseW);
const y=yStage*(paint.height/baseH);

return{x,y};
}

// ===== Dibujo =====
function getTool(){
return toolRadios.find(r=>r.checked)?.value||"brush";
}

function stroke(p0,p1){
ctx.save();
ctx.lineCap="round";
ctx.lineJoin="round";
ctx.lineWidth=+sizeInput.value;

if(getTool()==="eraser"){
ctx.globalCompositeOperation="destination-out";
ctx.strokeStyle="black";
}else{
ctx.globalCompositeOperation="source-over";
ctx.strokeStyle=colorInput.value;
}

ctx.beginPath();
ctx.moveTo(p0.x,p0.y);
ctx.lineTo(p1.x,p1.y);
ctx.stroke();
ctx.restore();
}

let drawing=false;
let last=null;

stage.addEventListener("pointerdown",e=>{
if(e.pointerType==="touch"&&pointers.size>=1)return;

stage.setPointerCapture(e.pointerId);
drawing=true;
last=getPos(e);
});

stage.addEventListener("pointermove",e=>{
if(pinching)return;
if(!drawing)return;
const pos=getPos(e);
stroke(last,pos);
last=pos;
});

stage.addEventListener("pointerup",()=>{
drawing=false;
last=null;
});

// ===== Zoom rueda =====
stage.addEventListener("wheel",e=>{
e.preventDefault();

const rect=stage.getBoundingClientRect();
const mx=e.clientX;
const my=e.clientY;

const old=viewScale;
const factor=e.deltaY<0?1.1:1/1.1;
viewScale=clampScale(old*factor);

const baseLeft=rect.left-viewX;
const baseTop=rect.top-viewY;

const ax=(mx-rect.left)/old;
const ay=(my-rect.top)/old;

viewX=mx-baseLeft-ax*viewScale;
viewY=my-baseTop-ay*viewScale;

applyView();

},{passive:false});

// ===== Pinch móvil =====
const pointers=new Map();
let pinching=false;
let pinchStart=null;

function distance(a,b){
return Math.hypot(a.x-b.x,a.y-b.y);
}

function midpoint(a,b){
return{x:(a.x+b.x)/2,y:(a.y+b.y)/2};
}

stage.addEventListener("pointerdown",e=>{
pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
if(pointers.size===2){
pinching=true;
const pts=[...pointers.values()];
pinchStart={
dist:distance(pts[0],pts[1]),
scale:viewScale
};
drawing=false;
}
});

stage.addEventListener("pointermove",e=>{
if(!pointers.has(e.pointerId))return;
pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
if(pinching&&pointers.size===2){
const pts=[...pointers.values()];
const ratio=distance(pts[0],pts[1])/pinchStart.dist;
viewScale=clampScale(pinchStart.scale*ratio);
applyView();
}
});

stage.addEventListener("pointerup",e=>{
pointers.delete(e.pointerId);
if(pointers.size<2)pinching=false;
});

// ===== Imagen =====
const img=new Image();
img.onload=()=>{
paint.width=img.width;
paint.height=img.height;
overlay.width=img.width;
overlay.height=img.height;

octx.drawImage(img,0,0);

const maxW=Math.min(window.innerWidth-24,1100);
const fitScale=Math.min(1,maxW/img.width);

stage.style.width=(img.width*fitScale)+"px";
stage.style.height=(img.height*fitScale)+"px";

baseW=stage.clientWidth;
baseH=stage.clientHeight;

applyView();
};
img.src=imgSrc;

})();
</script>

</body>
</html>
